import { NextRequest, NextResponse } from "next/server";
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET!;

export async function middleware(req: NextRequest) {
  console.log('üõ°Ô∏è Middleware running for:', req.nextUrl.pathname);
  
  const accessToken = req.cookies.get('access_token')?.value;
  console.log('üîê Access token found:', !!accessToken);
  
  if (!accessToken) {
    console.log('‚ùå No access token, redirecting to login');
    return NextResponse.redirect(new URL("/?modal=login", req.url));
  }

  try {
    const decoded = jwt.verify(accessToken, JWT_SECRET) as { userId: string };
    console.log('‚úÖ Token valid for user:', decoded.userId);
    return NextResponse.next();
  } catch (error) {
    console.error('‚ùå Token verification failed:', error);
    return NextResponse.redirect(new URL("/?modal=login", req.url));
  }
}

export const config = {
  matcher: [
    "/orders/:path*",
    "/delivery/:path*",
    "/orders",
    "/delivery",
  ],
};